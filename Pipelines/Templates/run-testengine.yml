parameters:
  - name: solutionName
    type: string
  - name: environmentId
    type: string
  - name: tenantId
    type: string

steps:
- pwsh: |
    git clone --recurse-submodules https://github.com/Grant-Archibald-MS/PowerApps-TestEngine-Modules.git
    
    cd PowerApps-TestEngine-Modules\PowerApps-TestEngine
    git checkout testengine-plugin
    cd ..

    cd src\PowerApps-TestEngine-Modules
    dotnet build
  displayName: "Build Test Engine"

- pwsh: |
    $env:user1Email = $env:TestAutomationUsername
    $env:user1Password = "$(TestAutomationPassword)"
    cd PowerApps-TestEngine-Modules\PowerApps-TestEngine\bin\Debug\PowerAppsTestEngine

    $splitName = "$(Build.Repository.Name)".Split("/")
    $repoName = $splitName[$splitName.Length - 1]
    $testPath = "$(Build.SourcesDirectory)\$(repoName)\$(solutionName)\tests"

    Write-Host "Searching for tests in"
    Write-Host $testPath
    Write-Host "As user $($env:user1Email)"
    if ( [System.IO.Directory]::Exists($testPath) ) {
      Write-Host "Found test directory"
      $testFiles = @(Get-ChildItem -Path $testPath -Filter *.fx.yaml -Recurse -ErrorAction SilentlyContinue -Force)
      if ($testFiles.length -eq 0) {
        Write-Host "No test files found"
      } else {
        ForEach ($testFile in $testFiles) {
          Write-Host $testFile.FullName
          dotnet PowerAppsTestEngine.dll -i $testFile.FullName -e "${{parameters.environmentId}}" -t "${{parameters.tenantId}}"
        }
      }
    } else {
      Write-Host "No tests found"
    }
  displayName: "Run Test Engine Tests"
    
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/*.trx'
  displayName: "Publish Test Results"

- task: CopyFiles@2
  inputs:
    SourceFolder: 'PowerApps-TestEngine-Modules\PowerApps-TestEngine\bin\Debug\PowerAppsTestEngine\TestOutput'
    Contents: |
      **/*
    targetFolder: $(Build.ArtifactStagingDirectory)

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: $(Build.ArtifactStagingDirectory)
    artifactName: TestOutput